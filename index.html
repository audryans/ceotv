<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEO Ryan Private Stream</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBxuc3suKfedfLcBIHNkfNQ9kUlZr2y1FQ",
  authDomain: "twitch-user-access.firebaseapp.com",
  projectId: "twitch-user-access",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* HELPERS */
function normalizePhone(input) {
  let p = input.replace(/\D/g, "");
  if (p.startsWith("0")) p = "254" + p.slice(1);
  if (!p.startsWith("254")) return null;
  return p;
}

function expiryTime() {
  return new Date(Date.now() + 6 * 60 * 60 * 1000);
}

/* REGISTER */
async function registerUser() {
  const name = document.getElementById("fullName").value.trim();
  const phone = normalizePhone(document.getElementById("phone").value.trim());
  const pass = document.getElementById("password").value.trim();
  const confirm = document.getElementById("confirmPassword").value.trim();

  if (!name || !phone || !pass || !confirm) {
    alert("Fill all fields");
    return;
  }

  if (pass.length < 6) {
    alert("Password must be at least 6 characters");
    return;
  }

  if (pass !== confirm) {
    alert("Passwords do not match");
    return;
  }

  const ref = doc(db, "viewers", phone);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    alert("Account already exists. Login instead.");
    return;
  }

  await setDoc(ref, {
    full_name: name,
    phone,
    password: pass,
    expires_at: expiryTime(),
    is_logged_in: false,
    is_approved: false,
    created_at: serverTimestamp()
  });

  alert("Registration successful. Wait for admin approval.");
}

/* LOGIN */
async function loginUser() {
  const phone = normalizePhone(document.getElementById("loginPhone").value.trim());
  const pass = document.getElementById("loginPassword").value.trim();

  if (!phone || !pass) {
    alert("Enter phone and password");
    return;
  }

  const ref = doc(db, "viewers", phone);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("Account not found");
    return;
  }

  const user = snap.data();

  if (!user.is_approved) {
    alert("Your account is not activated yet.");
    return;
  }

  if (Date.now() > user.expires_at.toDate().getTime()) {
    alert("Subscription expired.");
    return;
  }

  if (user.password !== pass) {
    alert("Wrong password.");
    return;
  }

  if (user.is_logged_in) {
    alert("Account already in use.");
    return;
  }

  await updateDoc(ref, { is_logged_in: true });
  localStorage.setItem("activeUser", phone);
  showStream();
}

/* LOGOUT */
async function logoutUser() {
  const phone = localStorage.getItem("activeUser");
  if (phone) {
    await updateDoc(doc(db, "viewers", phone), { is_logged_in: false });
    localStorage.removeItem("activeUser");
  }
  location.reload();
}

/* UI */
function showStream() {
  document.getElementById("lockScreen").style.display = "none";
  document.getElementById("streamWrap").style.display = "block";
}

/* WAIT FOR PAGE LOAD */
window.addEventListener("DOMContentLoaded", () => {

  document.getElementById("registerBtn")
    .addEventListener("click", registerUser);

  document.getElementById("loginBtn")
    .addEventListener("click", loginUser);

  document.getElementById("logoutBtn")
    .addEventListener("click", logoutUser);

});
</script>

<style>
body { margin:0; background:#000; font-family:Arial; color:#00ffe7; }
#lockScreen { height:100vh; display:flex; justify-content:center; align-items:center; }
.card { width:360px; padding:28px; border-radius:14px; background:#000; border:2px solid #00ffe7; text-align:center; }
input, button { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:none; }
button { background:linear-gradient(90deg,#00ffe7,#ff00ff); font-weight:bold; cursor:pointer; }
.switch { margin-top:14px; color:#ff00ff; cursor:pointer; }
#streamWrap { display:none; height:100vh; }
iframe { width:100%; height:100%; border:none; }
.logout-btn { position:fixed; top:12px; right:12px; padding:10px; background:#ff0055; color:#fff; border:none; border-radius:8px; cursor:pointer; z-index:999; }
</style>
</head>

<body>

<div id="lockScreen">
  <div class="card" id="registerCard">
    <h2>Register</h2>
    <input id="fullName" placeholder="Full Name">
    <input id="phone" placeholder="Phone Number">
    <input id="password" type="password" placeholder="Create Password">
    <input id="confirmPassword" type="password" placeholder="Confirm Password">
    <button id="registerBtn">Register</button>
    <div class="switch" onclick="registerCard.style.display='none';loginCard.style.display='block'">
      Already registered? Login
    </div>
  </div>

  <div class="card" id="loginCard" style="display:none;">
    <h2>Login</h2>
    <input id="loginPhone" placeholder="Phone Number">
    <input id="loginPassword" type="password" placeholder="Password">
    <button id="loginBtn">Enter Stream</button>
    <div class="switch" onclick="loginCard.style.display='none';registerCard.style.display='block'">
      Back to Register
    </div>
  </div>
</div>

<div id="streamWrap">
  <button id="logoutBtn" class="logout-btn">LOGOUT</button>
  <iframe
    src="https://player.twitch.tv/?channel=kpltv1&parent=audryans.github.io&autoplay=true&muted=true"
    allow="autoplay"
    allowfullscreen>
  </iframe>
</div>

</body>
</html>
