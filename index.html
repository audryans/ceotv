<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Private Stream</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* üî• FIREBASE CONFIG (UNCHANGED) */
const firebaseConfig = {
  apiKey: "AIzaSyBxuc3suKfedfLcBIHNkfNQ9kUlZr2y1FQ",
  authDomain: "twitch-user-access.firebaseapp.com",
  projectId: "twitch-user-access",
  storageBucket: "twitch-user-access.firebasestorage.app",
  messagingSenderId: "370819036531",
  appId: "1:370819036531:web:b6a2590eaec92e9394c106"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üîê PASSWORD GENERATOR */
function generatePassword() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let p = "SPT-";
  for (let i = 0; i < 4; i++) {
    p += chars[Math.floor(Math.random() * chars.length)];
  }
  return p;
}

/* ‚è± EXPIRY (2 HOURS) */
function getExpiryTime() {
  const d = new Date();
  d.setHours(d.getHours() + 2);
  return d;
}

/* üì≤ SEND TO ADMIN WHATSAPP */
function notifyAdmin(name, phone, password, expiresAt) {
  const admin = "254725820123"; // YOUR NUMBER
  const msg = `
NEW STREAM REGISTRATION

Name: ${name}
Phone: ${phone}
Password: ${password}
Expires: ${expiresAt.toLocaleString()}

Status: Pending payment
`;
  window.open(
    `https://wa.me/${admin}?text=${encodeURIComponent(msg)}`,
    "_blank"
  );
}

/* üìù REGISTRATION */
window.submitViewerData = async function () {
  const fullName = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();

  if (!fullName || !phone) {
    alert("Please fill all fields");
    return;
  }

  const password = generatePassword();
  const expiresAt = getExpiryTime();

  await addDoc(collection(db, "viewers"), {
    full_name: fullName,
    phone: phone,
    password: password,
    expires_at: expiresAt,
    created_at: serverTimestamp(),
    status: "pending"
  });

  // Save session locally
  localStorage.setItem("streamPassword", password);
  localStorage.setItem("expiresAt", expiresAt.getTime());

  notifyAdmin(fullName, phone, password, expiresAt);

  document.getElementById("registrationCard").style.display = "none";
  document.getElementById("passwordCard").style.display = "block";
};

/* üîì UNLOCK STREAM */
window.unlockStream = function () {
  const input = document.getElementById("passwordInput").value;
  const saved = localStorage.getItem("streamPassword");
  const expiry = localStorage.getItem("expiresAt");

  if (!saved || !expiry) {
    alert("Session expired. Please register again.");
    location.reload();
    return;
  }

  if (Date.now() > Number(expiry)) {
    alert("Password expired. Please register again.");
    localStorage.clear();
    location.reload();
    return;
  }

  if (input === saved) {
    document.getElementById("lockScreen").style.display = "none";
    document.getElementById("streamWrap").style.display = "flex";
  } else {
    alert("Incorrect password");
  }
};
</script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: radial-gradient(circle at top, #020202, #000);
  font-family: Arial, sans-serif;
  color: #00ffe7;
}

#lockScreen {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.96);
  display: flex;
  justify-content: center;
  align-items: center;
}

.lock-card {
  padding: 32px;
  border-radius: 16px;
  border: 2px solid #00ffe7;
  box-shadow: 0 0 30px #00ffe7, 0 0 60px #ff00ff;
  text-align: center;
  max-width: 380px;
  width: 92%;
}

.lock-card input, button {
  width: 100%;
  padding: 12px;
  margin-top: 14px;
  border-radius: 8px;
}

button {
  border: none;
  background: #00ffe7;
  font-weight: bold;
  cursor: pointer;
}

.stream-wrap {
  display: none;
  justify-content: center;
  padding: 10px;
}

iframe {
  width: 100%;
  height: 650px;
  border: none;
}
</style>
</head>

<body>

<div id="lockScreen">
  <div class="lock-card" id="registrationCard">
    <h2>Enter Your Details</h2>
    <input id="fullName" placeholder="Full Name">
    <input id="phone" placeholder="Phone Number">
    <button onclick="submitViewerData()">Next</button>
  </div>

  <div class="lock-card" id="passwordCard" style="display:none;">
    <h2>Enter Stream Password</h2>
    <input id="passwordInput" placeholder="Access Password">
    <button onclick="unlockStream()">Unlock Stream</button>
  </div>
</div>

<div class="stream-wrap" id="streamWrap">
  <iframe
    src="https://player.twitch.tv/?channel=sportpesaleaguetv&parent=audryans.github.io"
    allowfullscreen>
  </iframe>
</div>

</body>
</html>
