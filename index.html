<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEO Ryan Private Stream</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, getDocs,
  updateDoc, collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ðŸ”¥ FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBxuc3suKfedfLcBIHNkfNQ9kUlZr2y1FQ",
  authDomain: "twitch-user-access.firebaseapp.com",
  projectId: "twitch-user-access",
  storageBucket: "twitch-user-access.firebasestorage.app",
  messagingSenderId: "370819036531",
  appId: "1:370819036531:web:b6a2590eaec92e9394c106"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ðŸ“ž PHONE */
function normalizePhone(input) {
  let p = input.replace(/\D/g, "");
  if (p.startsWith("0")) p = "254" + p.slice(1);
  if (!p.startsWith("254")) return null;
  return p;
}

/* ðŸ” PASSWORD */
function generatePassword() {
  const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  return "SPT-" + [...Array(4)].map(() => c[Math.floor(Math.random()*c.length)]).join("");
}

function expiryTime() {
  return new Date(Date.now() + 2.5 * 60 * 60 * 1000);
}

/* ========== REGISTER ========= */
window.registerUser = async () => {
  const name = fullName.value.trim();
  const phone = normalizePhone(phoneInput.value.trim());
  if (!name || !phone) return alert("Invalid data");

  const ref = doc(db, "viewers", phone);
  if ((await getDoc(ref)).exists()) return alert("Account exists");

  await setDoc(ref, {
    full_name: name,
    phone,
    password: generatePassword(),
    expires_at: expiryTime(),
    is_logged_in: false,
    created_at: serverTimestamp()
  });

  alert("Registered. Admin will send password.");
};

/* ========== LOGIN ========= */
window.loginUser = async () => {
  const phone = normalizePhone(loginPhone.value.trim());
  const pass = loginPassword.value.trim();
  if (!phone || !pass) return;

  const ref = doc(db, "viewers", phone);
  const snap = await getDoc(ref);
  if (!snap.exists()) return alert("Not found");

  const u = snap.data();
  if (u.is_logged_in) return alert("Already in use");
  if (Date.now() > u.expires_at.toDate()) return alert("Expired");
  if (pass !== u.password) return alert("Wrong password");

  await updateDoc(ref, { is_logged_in: true });
  localStorage.setItem("activeUser", phone);
  showStream();
  watchExpiry(u.expires_at.toDate());
};

/* ========== LOGOUT ========= */
window.logoutUser = async () => {
  const phone = localStorage.getItem("activeUser");
  if (phone) await updateDoc(doc(db,"viewers",phone),{is_logged_in:false});
  localStorage.clear();
  location.reload();
};

/* ========== EXPIRY ========= */
let timer;
function watchExpiry(date) {
  timer = setTimeout(logoutUser, date - Date.now());
}

/* ========== ADMIN AUTH ========= */
window.adminLogin = async () => {
  await signInWithEmailAndPassword(
    auth,
    adminEmail.value,
    adminPassword.value
  );
};

window.adminLogout = async () => {
  await signOut(auth);
  adminPanel.style.display = "none";
};

/* ========== ADMIN DASH ========= */
async function loadAdmin() {
  adminPanel.style.display = "block";
  const tbody = viewersList;
  tbody.innerHTML = "";

  const snaps = await getDocs(collection(db,"viewers"));
  snaps.forEach(d => {
    const v = d.data();
    tbody.innerHTML += `
      <tr>
        <td>${v.full_name}</td>
        <td>${v.phone}</td>
        <td>${v.password}</td>
        <td>${v.is_logged_in ? "YES" : "NO"}</td>
        <td>${v.expires_at.toDate().toLocaleString()}</td>
        <td><button onclick="forceLogout('${d.id}')">Logout</button></td>
      </tr>`;
  });
}

window.forceLogout = async (p) => {
  await updateDoc(doc(db,"viewers",p),{is_logged_in:false});
  loadAdmin();
};

onAuthStateChanged(auth, u => u && loadAdmin());

function showStream(){
  lockScreen.style.display="none";
  streamWrap.style.display="block";
}
</script>
</head>

<body>

<!-- USER UI -->
<div id="lockScreen">
  <input id="fullName" placeholder="Full Name">
  <input id="phoneInput" placeholder="Phone">
  <button onclick="registerUser()">Register</button>

  <hr>

  <input id="loginPhone" placeholder="Phone">
  <input id="loginPassword" placeholder="Password">
  <button onclick="loginUser()">Login</button>

  <hr>

  <h3>Admin</h3>
  <input id="adminEmail" placeholder="Admin Email">
  <input id="adminPassword" type="password" placeholder="Admin Password">
  <button onclick="adminLogin()">Admin Login</button>
</div>

<div id="streamWrap" style="display:none">
  <button onclick="logoutUser()">LOGOUT</button>
  <iframe src="https://player.twitch.tv/?channel=sportpesaleaguetv&parent=localhost&parent=github.io"></iframe>
</div>

<div id="adminPanel" style="display:none">
  <h2>ADMIN DASHBOARD</h2>
  <button onclick="adminLogout()">Logout Admin</button>
  <table>
    <tbody id="viewersList"></tbody>
  </table>
</div>

</body>
</html>
