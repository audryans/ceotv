<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Stream Access</title>

<style>
  body {
    background: #050505;
    color: #00fff0;
    font-family: Arial, sans-serif;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    border: 2px solid #00fff0;
    border-radius: 12px;
    padding: 30px;
    width: 100%;
    max-width: 380px;
    text-align: center;
    box-shadow: 0 0 25px #00fff0;
  }
  h1 {
    color: #ff00ff;
    text-shadow: 0 0 15px #ff00ff;
  }
  input, button {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border-radius: 8px;
    background: transparent;
    border: 2px solid #00fff0;
    color: #00fff0;
    font-size: 15px;
  }
  button {
    cursor: pointer;
  }
  button:hover {
    background: #00fff0;
    color: #000;
    box-shadow: 0 0 15px #00fff0;
  }
  #otpSection { display: none; }
</style>
</head>

<body>

<div class="card">
  <h1>Secure Stream Access</h1>

  <input id="name" placeholder="Full Name">
  <input id="phone" placeholder="+2547XXXXXXXX">

  <div id="recaptcha-container"></div>

  <button id="sendOtpBtn">Send OTP</button>

  <div id="otpSection">
    <input id="otp" placeholder="Enter OTP">
    <button id="verifyOtpBtn">Verify & Watch</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth,
  RecaptchaVerifier,
  signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyA5lFZWR8KaPhYyGPEGD3VI3Ziz5ANpau4",
  authDomain: "private-stream-4e400.firebaseapp.com",
  projectId: "private-stream-4e400",
  storageBucket: "private-stream-4e400.appspot.com",
  messagingSenderId: "333562639763",
  appId: "1:333562639763:web:08e551d7c52e5cebff2466"
};

/* Init */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let confirmationResult;
let recaptchaVerifier;

/* Send OTP */
document.getElementById("sendOtpBtn").onclick = async () => {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();

  if (!name || !phone) {
    alert("Enter name and phone");
    return;
  }

  if (recaptchaVerifier) {
    recaptchaVerifier.clear();
  }

  // âœ… CORRECT ORDER HERE
  recaptchaVerifier = new RecaptchaVerifier(
    "recaptcha-container",
    { size: "normal" },
    auth
  );

  try {
    await setDoc(doc(db, "users", phone), { name, phone });

    confirmationResult = await signInWithPhoneNumber(
      auth,
      phone,
      recaptchaVerifier
    );

    alert("OTP sent");
    document.getElementById("otpSection").style.display = "block";

  } catch (error) {
    console.error(error);
    alert(error.message);
  }
};

/* Verify OTP */
document.getElementById("verifyOtpBtn").onclick = async () => {
  const code = document.getElementById("otp").value.trim();
  if (!code) return alert("Enter OTP");

  try {
    await confirmationResult.confirm(code);
    window.location.href = "stream.html";
  } catch {
    alert("Invalid OTP");
  }
};
</script>

</body>
</html>
