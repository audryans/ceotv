<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxuc3suKfedfLcBIHNkfNQ9kUlZr2y1FQ",
  authDomain: "twitch-user-access.firebaseapp.com",
  projectId: "twitch-user-access",
  storageBucket: "twitch-user-access.firebasestorage.app",
  messagingSenderId: "370819036531",
  appId: "1:370819036531:web:b6a2590eaec92e9394c106"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ðŸ” PASSWORD GEN */
function generatePassword() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  return "SPT-" + Array.from({ length: 4 }, () =>
    chars[Math.floor(Math.random() * chars.length)]
  ).join("");
}

/* â± 2H 30M EXPIRY */
function expiryTime() {
  return new Date(Date.now() + 2.5 * 60 * 60 * 1000);
}

/* ðŸ“ REGISTER */
window.submitViewerData = async () => {
  const name = fullName.value.trim();
  const phone = phoneInput.value.trim();

  if (!name || !phone) return alert("Fill all fields");

  const ref = doc(db, "viewers", phone);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    alert("Account exists. Please login.");
    return;
  }

  const password = generatePassword();
  const expires = expiryTime();

  await setDoc(ref, {
    full_name: name,
    phone,
    password,
    expires_at: expires,
    is_logged_in: false,
    created_at: serverTimestamp()
  });

  window.open(
    `https://wa.me/254725820123?text=${encodeURIComponent(
      `NEW STREAM USER\nName: ${name}\nPhone: ${phone}\nPassword: ${password}\nExpires: ${expires}`
    )}`,
    "_blank"
  );

  alert("Registration successful. Password will be sent after payment.");
};

/* ðŸ”“ LOGIN */
window.unlockStream = async () => {
  const phone = phoneLogin.value.trim();
  const inputPassword = passwordInput.value.trim();

  const ref = doc(db, "viewers", phone);
  const snap = await getDoc(ref);

  if (!snap.exists()) return alert("Account not found");

  const user = snap.data();

  if (Date.now() > user.expires_at.toDate().getTime()) {
    alert("Your password is expired, kindly re-register");
    return;
  }

  if (user.is_logged_in) {
    alert("Account already in use on another device");
    return;
  }

  if (inputPassword !== user.password) {
    alert("Incorrect password");
    return;
  }

  await updateDoc(ref, { is_logged_in: true });

  lockScreen.style.display = "none";
  streamWrap.style.display = "flex";
};

/* ðŸ”’ AUTO LOGOUT ON CLOSE */
window.addEventListener("beforeunload", async () => {
  const phone = phoneLogin.value?.trim();
  if (phone) {
    await updateDoc(doc(db, "viewers", phone), { is_logged_in: false });
  }
});
</script>
