<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEO Ryan Private Stream</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:#030b10;
  color:#0ff;
}
input,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border:none;
  border-radius:6px;
}
input{
  background:#020a0f;
  color:#0ff;
  border:1px solid #0ff4;
  box-shadow:0 0 10px #0ff;
}
button{
  background:linear-gradient(90deg,#00f5ff,#00ffa6);
  font-weight:bold;
  cursor:pointer;
  box-shadow:0 0 15px #0ff;
  transition:0.2s;
}
button:hover{
  box-shadow:0 0 25px #0ff,0 0 45px #0ff;
}
.whatsapp{
  background:linear-gradient(90deg,#25D366,#1ebe5d);
  color:#000;
  font-weight:bold;
  box-shadow:0 0 15px #0f0;
}
hr{border:1px solid #0ff2}
#lockScreen,#adminPanel{
  max-width:420px;
  margin:auto;
  padding:20px;
}
#streamWrap iframe{
  width:100%;
  height:260px;
  border:2px solid #0ff;
  box-shadow:0 0 25px #0ff;
}
table{
  width:100%;
  border-collapse:collapse;
}
td,th{
  border:1px solid #0ff2;
  padding:6px;
  font-size:12px;
  text-align:center;
}
.badge{
  padding:6px 10px;
  border-radius:20px;
  background:#0ff;
  color:#000;
  font-weight:bold;
  display:inline-block;
  margin-bottom:10px;
  box-shadow:0 0 15px #0ff;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, collection, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyBxuc3suKfedfLcBIHNkfNQ9kUlZr2y1FQ",
  authDomain: "twitch-user-access.firebaseapp.com",
  projectId: "twitch-user-access"
});
const db = getFirestore(app);
const auth = getAuth(app);

/* HELPERS */
const normPhone = p=>{
  p=p.replace(/\D/g,"");
  if(p.startsWith("0")) p="254"+p.slice(1);
  return p.startsWith("254")?p:null;
};

const expiryAt = ()=>Date.now()+2.5*60*60*1000;
const token = ()=>crypto.randomUUID();

/* REGISTER */
window.registerUser = async ()=>{
  const name = fullName.value.trim();
  const phone = normPhone(phoneInput.value.trim());
  if(!name||!phone) return alert("Invalid data");

  const ref = doc(db,"viewers",phone);
  const snap = await getDoc(ref);

  if(snap.exists() && snap.data().expires_at>Date.now())
    return alert("Account already active");

  const pass = "SPT-"+Math.random().toString(36).slice(2,6).toUpperCase();

  await setDoc(ref,{
    full_name: name,
    phone,
    if(pass !== u.password) return alert("Wrong password"); // stored in plain text so admin can send it
    expires_at: expiryAt(),
    session_token: null,
    created_at: serverTimestamp()
  });

  alert(`Registered! Contact admin on WhatsApp for password.`);
};

/* LOGIN */
window.loginUser = async ()=>{
  const phone = normPhone(loginPhone.value.trim());
  const pass = loginPassword.value.trim();
  if(!phone||!pass) return;

  const ref = doc(db,"viewers",phone);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert("User not found");

  const u = snap.data();
  if(Date.now()>u.expires_at){
    await deleteDoc(ref);
    return alert("Password expired. Please re-register.");
  }
  if(pass!==u.password) return alert("Wrong password");
  if(u.session_token) return alert("Already logged in elsewhere");

  const t = token();
  await updateDoc(ref,{session_token:t});
  localStorage.setItem("session",JSON.stringify({phone,t}));

  showStream();
  monitorExpiry();
};

/* RESTORE SESSION */
const restore = async ()=>{
  const s = JSON.parse(localStorage.getItem("session")||"null");
  if(!s) return;
  const ref = doc(db,"viewers",s.phone);
  const snap = await getDoc(ref);
  if(!snap.exists()) return logoutUser();
  const u = snap.data();
  if(u.session_token!==s.t || Date.now()>u.expires_at) return logoutUser();
  showStream();
  monitorExpiry();
};
restore();

/* EXPIRY WATCH */
let expInt;
function monitorExpiry(){
  clearInterval(expInt);
  expInt = setInterval(async ()=>{
    const s = JSON.parse(localStorage.getItem("session")||"null");
    if(!s) return;
    const snap = await getDoc(doc(db,"viewers",s.phone));
    if(!snap.exists() || Date.now()>snap.data().expires_at) logoutUser();
  },5000);
}

/* LOGOUT */
window.logoutUser = async ()=>{
  const s = JSON.parse(localStorage.getItem("session")||"null");
  if(s) await updateDoc(doc(db,"viewers",s.phone),{session_token:null});
  localStorage.clear();
  location.reload();
};
window.addEventListener("beforeunload",logoutUser);

/* ADMIN */
window.adminLogin = async ()=>{
  await signInWithEmailAndPassword(auth,adminEmail.value,adminPassword.value);
};
window.adminLogout = async ()=>{
  await signOut(auth);
  adminPanel.style.display="none";
};

onAuthStateChanged(auth,u=>{
  if(!u) return;
  adminPanel.style.display="block";
  loadAdmin();
  setInterval(loadAdmin,5000);
});

/* ADMIN DASH */
async function loadAdmin(){
  viewersList.innerHTML="";
  let active=0;
  const snaps = await getDocs(collection(db,"viewers"));
  snaps.forEach(d=>{
    const v = d.data();
    if(v.session_token) active++;
    viewersList.innerHTML += `
      <tr>
        <td>${v.full_name}</td>
        <td>${v.phone}</td>
        <td>${v.password}</td>
        <td>${v.session_token?"YES":"NO"}</td>
        <td>${new Date(v.expires_at).toLocaleString()}</td>
        <td><button onclick="forceLogout('${d.id}')">Logout</button></td>
      </tr>`;
  });
  activeCount.innerText = active;
}

window.forceLogout = async p=>{
  await updateDoc(doc(db,"viewers",p),{session_token:null});
  loadAdmin();
};

function showStream(){
  lockScreen.style.display="none";
  streamWrap.style.display="block";
  stream.src=`https://player.twitch.tv/?channel=sportpesaleaguetv&parent=${location.hostname}`;
}
</script>
</head>

<body>

<div id="lockScreen">
  <input id="fullName" placeholder="Full Name">
  <input id="phoneInput" placeholder="Phone">
  <button onclick="registerUser()">Register</button>

  <button class="whatsapp"
    onclick="window.open('https://wa.me/254725820123','_blank')">
    Contact Admin on WhatsApp
  </button>

  <hr>

  <input id="loginPhone" placeholder="Phone">
  <input id="loginPassword" placeholder="Password">
  <button onclick="loginUser()">Login</button>

  <hr>

  <h3>Admin</h3>
  <input id="adminEmail" placeholder="Admin Email">
  <input id="adminPassword" type="password" placeholder="Admin Password">
  <button onclick="adminLogin()">Admin Login</button>
</div>

<div id="streamWrap" style="display:none">
  <button onclick="logoutUser()">LOGOUT</button>
  <button class="whatsapp"
    onclick="window.open('https://wa.me/254725820123','_blank')">
    WhatsApp Admin
  </button>
  <iframe id="stream" allowfullscreen></iframe>
</div>

<div id="adminPanel" style="display:none">
  <h2>ADMIN DASHBOARD</h2>
  <span class="badge">Active Viewers: <span id="activeCount">0</span></span>
  <button onclick="adminLogout()">Logout Admin</button>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Password</th>
        <th>Logged In</th>
        <th>Expires At</th>
        <th>Force Logout</th>
      </tr>
    </thead>
    <tbody id="viewersList"></tbody>
  </table>
</div>

</body>
</html>
